{"assignees":[],"author":{"id":"MDQ6VXNlcjIyODUzMjIy","is_bot":false,"login":"TheMorpheus407","name":"The Morpheus Tutorials"},"body":"## Summary\nConfigure Drizzle ORM for PostgreSQL with versioned migrations, connection pooling, and the first foundational migration. This establishes the database layer that all future schema work builds upon.\n\n## Requirements\n\n### Drizzle ORM Configuration\n- `drizzle-orm` with `postgres-js` driver (or `@neondatabase/serverless` for edge compatibility)\n- `drizzle-kit` for migration generation and management\n- `drizzle.config.ts` at API package root\n- Connection pooling via `postgres` driver (configurable pool size)\n\n### Database Connection Module\n```\napps/api/src/shared/database/\n  connection.ts       # Drizzle client singleton with connection pooling\n  schema/\n    index.ts          # Schema barrel export\n    tenants.ts        # Initial tenant table schema\n  migrations/         # Auto-generated migration files\n  seed.ts             # Seed script for development data\n```\n\n### First Migration: Foundation Tables\nPer DD-10 principles (tenant_id on every table from day one):\n\n```sql\n-- Schema: public\nCREATE TABLE IF NOT EXISTS public.tenants (\n  tenant_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(255) NOT NULL,\n  slug VARCHAR(63) NOT NULL UNIQUE,\n  status VARCHAR(20) NOT NULL DEFAULT 'active',\n  settings JSONB NOT NULL DEFAULT '{}',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- Default 'system' tenant for consumer users\nINSERT INTO public.tenants (tenant_id, name, slug, status)\nVALUES ('00000000-0000-0000-0000-000000000001', 'The DMZ', 'system', 'active');\n```\n\n### Migration Scripts\n- `pnpm --filter api db:generate` - Generate migration from schema changes\n- `pnpm --filter api db:migrate` - Run pending migrations\n- `pnpm --filter api db:studio` - Open Drizzle Studio (dev GUI)\n- `pnpm --filter api db:seed` - Seed development data\n- `pnpm --filter api db:reset` - Drop all, re-migrate, re-seed (dev only)\n\n### Seed Script\n- Create default 'system' tenant\n- Create a test tenant for development\n- Idempotent (safe to run multiple times)\n\n### Connection Configuration\n- Pool size configurable via env (default: 10 for dev, 25 for prod)\n- Connection timeout: 30 seconds\n- Idle timeout: 10 seconds\n- SSL configurable via env (off for local, on for production)\n\n## Acceptance Criteria\n- [ ] `pnpm --filter api db:migrate` runs the first migration successfully\n- [ ] `public.tenants` table exists with correct schema\n- [ ] Default 'system' tenant is seeded\n- [ ] `pnpm --filter api db:generate` detects schema changes\n- [ ] Drizzle Studio opens and shows the schema\n- [ ] Connection pooling is configured and working\n- [ ] Migration files are versioned and committed to git\n- [ ] Seed script is idempotent\n\n## References\n- MILESTONES.md: M0 \"Database migration framework\" deliverable\n- DD-10: Database Schema & Data Model (all sections on tenant_id, conventions)\n- DD-10 Section 29: Migration, Versioning, and Backward Compatibility\n- DD-09 Section 1.2: Database connection module\n- Guiding Principle #1: \"Event sourcing is canonical from day one\"\n- Guiding Principle #2: \"tenant_id on every table from day one\"\n\n## Dependencies\n- M0-06: Docker Compose development environment (PostgreSQL must be running)\n- M0-03: Scaffold Fastify backend application\n\n---","comments":[],"createdAt":"2026-02-05T15:22:09Z","labels":[{"id":"LA_kwDOQ_FFzs8AAAACXIw6vQ","name":"M0: Bootstrap","description":"Milestone 0: Project Bootstrap","color":"1D76DB"},{"id":"LA_kwDOQ_FFzs8AAAACXIw7OA","name":"backend","description":"Backend (Fastify)","color":"E8560C"},{"id":"LA_kwDOQ_FFzs8AAAACXIw8SA","name":"database","description":"Database, migrations, schema","color":"D93F0B"}],"number":7,"title":"M0-07: Set up Drizzle ORM and database migration framework","updatedAt":"2026-02-05T15:22:09Z","url":"https://github.com/TheMorpheus407/the-dmz/issues/7"}
