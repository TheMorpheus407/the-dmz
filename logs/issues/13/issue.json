{"assignees":[],"author":{"id":"MDQ6VXNlcjIyODUzMjIy","is_bot":false,"login":"TheMorpheus407","name":"The Morpheus Tutorials"},"body":"## Summary\nConfigure Vitest as the unit and integration testing framework across all workspace packages. Set up test utilities, coverage reporting, and initial smoke tests to validate the test infrastructure works.\n\n## Requirements\n\n### Vitest Configuration\n\n#### Root Config (`vitest.workspace.ts`)\n```typescript\nexport default [\n  'apps/api',\n  'apps/web',\n  'packages/shared',\n];\n```\n\n#### API Package (`apps/api/vitest.config.ts`)\n- Environment: `node`\n- Coverage provider: `v8`\n- Coverage thresholds: 0% initially (ramp up over milestones)\n- Path aliases matching tsconfig\n- Setup file for test database connection\n- Test patterns: `**/__tests__/**/*.test.ts`, `**/*.spec.ts`\n\n#### Web Package (`apps/web/vitest.config.ts`)\n- Environment: `jsdom` (or `happy-dom`)\n- Svelte testing with `@testing-library/svelte`\n- Coverage provider: `v8`\n- Path aliases matching svelte.config.js\n- Test patterns: `**/__tests__/**/*.test.ts`, `**/*.spec.ts`\n\n#### Shared Package (`packages/shared/vitest.config.ts`)\n- Environment: `node`\n- Coverage provider: `v8`\n\n### Test Utilities\n```\napps/api/src/__tests__/\n  setup.ts              # Test setup (env vars, mocks)\n  helpers/\n    db.ts               # Test DB utilities (transaction rollback pattern)\n    factory.ts          # Test data factories (placeholder)\napps/web/src/__tests__/\n  setup.ts              # Test setup (DOM mocks)\n  helpers/\n    render.ts           # Custom render with providers\n```\n\n### Initial Smoke Tests\n- `packages/shared`: Test that type guards work, error codes export\n- `apps/api`: Test health endpoint returns 200 (unit test with Fastify inject)\n- `apps/web`: Test that a placeholder component renders (Svelte component test)\n\n### Coverage Configuration\n- Reporter: `text`, `lcov`, `html`\n- Coverage output: `coverage/` (gitignored)\n- Collect coverage from: `src/**/*.{ts,svelte}` (excluding tests)\n\n### Scripts\n- `pnpm test` - Run all tests via Turborepo\n- `pnpm test:watch` - Watch mode for active development\n- `pnpm test:coverage` - Run tests with coverage report\n- `pnpm --filter api test` - Run API tests only\n- `pnpm --filter web test` - Run web tests only\n\n### CI Integration\n- Tests run in CI workflow\n- Coverage reports uploaded as artifacts\n- Future: Coverage comment on PRs\n\n## Acceptance Criteria\n- [ ] `pnpm test` runs tests across all packages\n- [ ] At least one test passes in each package (api, web, shared)\n- [ ] Coverage report is generated in `coverage/`\n- [ ] Watch mode works for active development\n- [ ] Svelte component testing works with @testing-library/svelte\n- [ ] Fastify inject-based testing works for API routes\n- [ ] Test isolation: each test runs independently\n- [ ] CI can run tests without additional setup\n\n## References\n- MILESTONES.md: M0 \"Testing infrastructure - Vitest (unit)\"\n- DD-08 Section 24: Testing and Quality Strategy\n- DD-09: Backend Architecture (module test structure)\n- Cross-cutting: Testing in CI\n\n## Dependencies\n- M0-01: Initialize pnpm monorepo workspace\n- M0-02: SvelteKit frontend (for web tests)\n- M0-03: Fastify backend (for API tests)\n\n---","comments":[{"id":"IC_kwDOQ_FFzs7mDT1s","author":{"login":"TheMorpheus407"},"authorAssociation":"OWNER","body":"# Research: Issue #13 — Vitest Unit Testing Infrastructure\n\n**Key Findings**\n- Vitest is installed and tests already exist in `apps/api`, `apps/web`, and `packages/shared`, but only `apps/web/vitest.config.ts` exists and it is minimal (node env only).\n- No root `vitest.workspace.ts` or package configs for API/shared; no test setup utilities per the issue spec.\n- `apps/web` lacks `@testing-library/svelte` and `jsdom`/`happy-dom`, so Svelte component tests cannot run yet.\n- Existing tests in `packages/shared` and `apps/web` are not under `__tests__`, so the specified glob (`**/__tests__/**/*.test.ts`, `**/*.spec.ts`) would exclude them unless expanded or files are moved.\n- CI already runs tests with coverage and uploads artifacts; new configs should align with `.github/workflows/ci.yml`.\n\n## Current Behavior (Repo)\n- Root `pnpm test` runs `turbo run test` (`package.json`). Turbo defines `test` with `dependsOn: ['^build']` and `outputs: ['coverage/**']` (`turbo.json`), so tests depend on builds.\n- `apps/api` tests use Fastify `app.inject` and a custom config override to set `NODE_ENV: 'test'` (`apps/api/src/modules/health/__tests__/health.routes.test.ts`).\n- `apps/web` has only a utility test (`apps/web/src/lib/utils/time.test.ts`), and `apps/web/vitest.config.ts` sets `environment: 'node'` with no Svelte/Vite plugin integration.\n- `packages/shared` has multiple `.test.ts` files located in `src/` (for example `packages/shared/src/utils/type-guards.test.ts`).\n- CI (`.github/workflows/ci.yml`) runs `pnpm --filter <pkg> test -- --coverage ...` and uploads `**/coverage/**` artifacts.\n\n## Gaps vs Issue Requirements\n- Missing root `vitest.workspace.ts`.\n- Missing `apps/api/vitest.config.ts` and `packages/shared/vitest.config.ts`.\n- `apps/web/vitest.config.ts` should use `jsdom`/`happy-dom`, Svelte testing setup, coverage config, and aliases. Current config does not.\n- Missing test utilities directories and setup files under `apps/api/src/__tests__/` and `apps/web/src/__tests__/`.\n- Missing Svelte testing dependencies (`@testing-library/svelte`, plus `jsdom` or `happy-dom`).\n- Missing `test:watch` and `test:coverage` scripts (root + packages) and corresponding Turbo tasks.\n- Required test globs exclude existing `*.test.ts` files outside `__tests__` unless updated.\n\n## Root Cause Analysis\n- Vitest was added early (dependencies and a few smoke tests), but full configuration and utilities were deferred.\n- Only the web package received a stub `vitest.config.ts` during scaffold; API/shared configs never landed.\n- DOM testing dependencies were not added, blocking component tests.\n- Workspace-level Vitest orchestration (`vitest.workspace.ts`) was not created, so test execution is per-package only.\n\n## Impacted Modules / Files\n- Root: `vitest.workspace.ts`, `package.json` (scripts), `turbo.json` (tasks).\n- API: `apps/api/vitest.config.ts`, `apps/api/src/__tests__/setup.ts`, `apps/api/src/__tests__/helpers/db.ts`, `apps/api/src/__tests__/helpers/factory.ts`.\n- Web: `apps/web/vitest.config.ts`, `apps/web/src/__tests__/setup.ts`, `apps/web/src/__tests__/helpers/render.ts`, `apps/web/package.json` (devDependencies).\n- Shared: `packages/shared/vitest.config.ts`.\n- CI: `.github/workflows/ci.yml` only if script names/paths change.\n\n## Constraints / Dependencies\n- ESM repo (`\"type\": \"module\"`), so Vitest config files must be ESM/TS.\n- `@the-dmz/shared` exports point to `dist/`; API/Web tests currently rely on shared being built (Turbo test depends on build, and CI builds shared before tests).\n- Svelte 5 compatibility: ensure `@testing-library/svelte` version supports Svelte 5.\n- DD-09 expects module tests under `__tests__/` directories; DD-08 expects unit + component + E2E coverage.\n\n## Options / Approaches\n1. **Follow the issue spec closely (recommended)**\n- Add root `vitest.workspace.ts` with `['apps/api', 'apps/web', 'packages/shared']`.\n- Add per-package `vitest.config.ts` with env, coverage provider, setup files, and include globs.\n- Add `@testing-library/svelte` + `jsdom` (or `happy-dom`) to `apps/web`.\n- Add test setup helpers and a simple Svelte component smoke test.\n\n2. **Unify via root workspace config only**\n- Use `vitest.workspace.ts` plus minimal per-package configs.\n- Optionally alias `@the-dmz/shared` to source to avoid build dependency, but that diverges from current CI/build assumptions.\n\n## Risks / Tradeoffs\n- **Test glob mismatch**: restricting to `**/__tests__/**/*.test.ts` + `**/*.spec.ts` will skip existing `*.test.ts` outside `__tests__`. Either expand globs or relocate tests.\n- **DOM env dependency**: `environment: 'jsdom'` requires adding `jsdom` (not currently in `apps/web`).\n- **Svelte 5 compatibility**: confirm `@testing-library/svelte` version supports Svelte 5.\n- **Build dependency**: API/Web tests import `@the-dmz/shared`; without source aliasing, they require the shared build (current CI already does this).\n- **Watch mode**: `apps/web` `test` script runs preflight scripts; watch mode may need a lighter script to avoid rerunning these on each change.\n\n## Test Ideas / Validation\n- `pnpm test` runs all package tests via Turbo.\n- `pnpm --filter @the-dmz/api test` passes Fastify `inject` health route tests.\n- `pnpm --filter @the-dmz/web test` runs a Svelte component smoke test under `jsdom`/`happy-dom`.\n- `pnpm --filter @the-dmz/shared test` runs schema/type-guard tests.\n- `pnpm test:coverage` generates `coverage/` output.\n- `pnpm test:watch` runs in watch mode without repeatedly failing preflight scripts.\n","createdAt":"2026-02-06T10:44:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/TheMorpheus407/the-dmz/issues/13#issuecomment-3859627372","viewerDidAuthor":true},{"id":"IC_kwDOQ_FFzs7mEoC0","author":{"login":"TheMorpheus407"},"authorAssociation":"OWNER","body":"# Research: Issue #13 — Vitest Unit Testing Infrastructure\n\n**Key Findings**\n- The Vitest workspace and per-package configs already exist: `vitest.workspace.ts`, `apps/api/vitest.config.ts`, `apps/web/vitest.config.ts`, and `packages/shared/vitest.config.ts`.\n- Svelte component testing is wired up: `@testing-library/svelte` and `jsdom` are in `apps/web` devDependencies, the Vitest config uses `svelteTesting` + `jsdom`, and a smoke component test exists under `apps/web/src/__tests__/smoke/`.\n- API + shared packages have passing unit tests and coverage configuration with v8 reporters; API test utilities (`apps/api/src/__tests__/helpers/*`) and setup file exist.\n- Root scripts and Turbo tasks include `test`, `test:watch`, and `test:coverage`, while CI runs per-package tests with coverage and overrides thresholds via CLI.\n\n## Current Behavior (Repo)\n- Root `pnpm test` runs `turbo run test` (`package.json`), and Turbo’s `test` task depends on `^build` with `coverage/**` outputs (`turbo.json`).\n- `vitest.workspace.ts` exists at repo root and lists `apps/api`, `apps/web`, `packages/shared`.\n- `apps/api` runs `vitest run` and includes `apps/api/vitest.config.ts` with `node` env, setup file, include globs for `__tests__` and `*.spec.ts`, and v8 coverage config.\n- `apps/web` runs `vitest run` after two preflight scripts; its config uses `jsdom`, `sveltekit()` + `svelteTesting()` plugins, alias config matching `svelte.config.js`, and coverage over `src/**/*.{ts,svelte}`.\n- `packages/shared` runs `generate:schemas` before tests and has a Vitest config covering `src/**/*.test.ts`/`*.spec.ts` with v8 coverage.\n- CI (`.github/workflows/ci.yml`) builds `@the-dmz/shared` first, then runs per-package tests with coverage and low thresholds set via CLI flags.\n\n## Gaps / Deviations vs Issue Requirements\n- No functional gaps found relative to the issue spec; the required configs, setup files, helpers, and smoke tests are present.\n- `apps/web` and `packages/shared` test globs are broader than the spec (they include colocated `src/**/*.test.ts`), which is intentional to cover existing tests outside `__tests__`.\n- Root `pnpm test` uses Turbo instead of `vitest --workspace`; the workspace file is still useful for direct `vitest` runs but is not the default path.\n- `apps/web` `test:coverage` re-runs the preflight scripts via `pnpm run test -- --coverage`, which can fail if `@the-dmz/shared` is not built locally.\n\n## Root Cause Analysis\n- The original issue likely stemmed from incomplete testing scaffolding (missing workspace config, per-package configs, DOM test dependencies, and setup utilities). The current repo state shows these have been added, and smoke tests are present across packages, indicating the root cause has been addressed.\n\n## Impacted Modules / Files\n- Root: `vitest.workspace.ts`, `package.json`, `turbo.json`.\n- API: `apps/api/vitest.config.ts`, `apps/api/src/__tests__/setup.ts`, `apps/api/src/__tests__/helpers/db.ts`, `apps/api/src/__tests__/helpers/factory.ts`, `apps/api/src/modules/health/__tests__/health.routes.test.ts`.\n- Web: `apps/web/vitest.config.ts`, `apps/web/src/__tests__/setup.ts`, `apps/web/src/__tests__/helpers/render.ts`, `apps/web/src/__tests__/smoke/smoke-component.test.ts`, `apps/web/src/__tests__/fixtures/Smoke.svelte`.\n- Shared: `packages/shared/vitest.config.ts`, `packages/shared/src/**/*.test.ts`.\n- CI: `.github/workflows/ci.yml` (coverage thresholds enforced via CLI overrides).\n\n## Constraints / Dependencies\n- ESM repo (`\"type\": \"module\"`), so Vitest configs are ESM/TS and must remain compatible.\n- `@the-dmz/shared` exports point to `dist/`; tests in other packages rely on a built shared package (Turbo test depends on build; CI builds shared explicitly).\n- Svelte 5 testing requires `@testing-library/svelte` + a DOM implementation (`jsdom` is currently used).\n- Backend module structure in DD-09 expects tests under `__tests__` directories; shared and web already include colocated tests, so include globs must allow both.\n\n## Alternative Approaches\n- Use `vitest --workspace` at the root instead of Turbo, if a single command should orchestrate all packages without build dependency.\n- Swap `jsdom` for `happy-dom` in web tests for faster DOM simulation if needed.\n- Add a path alias to map `@the-dmz/shared` to source in tests to avoid pre-building the shared package (tradeoff: diverges from runtime resolution).\n\n## Risks / Tradeoffs\n- Preflight scripts in `apps/web` `test`/`test:coverage` can fail if `@the-dmz/shared` isn’t built locally; Turbo mitigates this, but direct package runs need care.\n- CI coverage thresholds are enforced via CLI flags (currently `1%`), which override the `0%` thresholds in config; discrepancies could confuse local vs CI outcomes.\n- API test helpers include DB utilities (`resetTestDatabase`, transaction rollback) that will require a live test database when used; they are placeholders today.\n\n## Test Ideas / Validation\n- `pnpm test` at repo root to ensure Turbo orchestration and coverage outputs.\n- `pnpm --filter @the-dmz/api test` to validate Fastify `inject` health tests.\n- `pnpm --filter @the-dmz/web test` to confirm Svelte component tests run under `jsdom`.\n- `pnpm --filter @the-dmz/shared test` to confirm schema generation + unit tests.\n- `pnpm test:coverage` to verify `coverage/` directories are produced across packages.\n","createdAt":"2026-02-06T11:43:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/TheMorpheus407/the-dmz/issues/13#issuecomment-3859972276","viewerDidAuthor":true}],"createdAt":"2026-02-05T15:23:29Z","labels":[{"id":"LA_kwDOQ_FFzs8AAAACXIw6vQ","name":"M0: Bootstrap","description":"Milestone 0: Project Bootstrap","color":"1D76DB"},{"id":"LA_kwDOQ_FFzs8AAAACXIw81A","name":"testing","description":"Testing infrastructure","color":"FBCA04"}],"number":13,"title":"M0-13: Set up Vitest unit testing infrastructure","updatedAt":"2026-02-06T11:43:08Z","url":"https://github.com/TheMorpheus407/the-dmz/issues/13"}
