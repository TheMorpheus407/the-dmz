name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run dependency audit (high+)
        id: dependency-audit
        continue-on-error: true
        run: |
          mkdir -p security-reports
          pnpm audit --audit-level high --json > security-reports/dependency-audit.json 2>&1
      - name: Upload dependency audit artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-${{ matrix.node }}
          path: security-reports/dependency-audit.json
          if-no-files-found: warn
      - name: Enforce dependency audit threshold
        if: steps.dependency-audit.outcome == 'failure'
        run: |
          echo "Dependency audit failed due to high/critical vulnerabilities."
          exit 1

  lint-and-typecheck:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package
        run: pnpm --filter @the-dmz/shared build
      - name: Sync SvelteKit generated files
        run: pnpm --filter @the-dmz/web exec svelte-kit sync
      - name: Lint
        run: pnpm lint
      - name: Typecheck
        run: pnpm typecheck
      - name: Format check
        run: pnpm format:check

  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package for tests
        run: pnpm --filter @the-dmz/shared build
      - name: Run repository script tests
        run: pnpm test:scripts
      - name: Run unit tests with coverage
        env:
          CI: true
        run: |
          pnpm --filter @the-dmz/shared test -- \
            --coverage \
            --coverage.provider=v8 \
            --coverage.reporter=lcov \
            --coverage.reporter=text \
            --coverage.thresholds.lines=1 \
            --coverage.thresholds.functions=1 \
            --coverage.thresholds.branches=1 \
            --coverage.thresholds.statements=1
          pnpm --filter @the-dmz/api test -- \
            --coverage \
            --coverage.provider=v8 \
            --coverage.reporter=lcov \
            --coverage.reporter=text \
            --coverage.thresholds.lines=1 \
            --coverage.thresholds.functions=1 \
            --coverage.thresholds.branches=1 \
            --coverage.thresholds.statements=1
          pnpm --filter @the-dmz/web test -- \
            --coverage \
            --coverage.provider=v8 \
            --coverage.reporter=lcov \
            --coverage.reporter=text \
            --coverage.thresholds.lines=1 \
            --coverage.thresholds.functions=1 \
            --coverage.thresholds.branches=1 \
            --coverage.thresholds.statements=1
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.node }}
          path: |
            **/coverage/**
          if-no-files-found: warn

  e2e-tests:
    needs: [unit-tests]
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.1-jammy
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: dmz
          POSTGRES_PASSWORD: dmz_dev
          POSTGRES_DB: dmz_test
        options: >-
          --health-cmd "pg_isready -U dmz -d dmz_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 5s
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package for runtime imports
        run: pnpm --filter @the-dmz/shared build
      - name: Run Playwright E2E tests
        env:
          CI: true
          HOME: /root
          NODE_ENV: test
          DATABASE_TEST_URL: postgres://dmz:dmz_dev@postgres:5432/dmz_test
          REDIS_URL: redis://redis:6379
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5173
          PLAYWRIGHT_API_BASE_URL: http://127.0.0.1:3001
        run: pnpm test:e2e
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-${{ matrix.node }}
          path: |
            playwright-report/
            test-results/
          if-no-files-found: warn

  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package
        run: pnpm --filter @the-dmz/shared build
      - name: Build web app
        run: pnpm --filter @the-dmz/web build
      - name: Build api app
        run: pnpm --filter @the-dmz/api build
      - name: Verify build artifacts
        run: |
          test -d packages/shared/dist
          test -d apps/web/build
          test -d apps/api/dist

  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    services:
      postgres:
        image: postgres:16-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: dmz
          POSTGRES_PASSWORD: dmz_dev
          POSTGRES_DB: dmz_dev
        options: >-
          --health-cmd "pg_isready -U dmz -d dmz_dev"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 5s
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package
        run: pnpm --filter @the-dmz/shared build
      - name: Run migrations (placeholder)
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://dmz:dmz_dev@localhost:5432/dmz_dev
          REDIS_URL: redis://localhost:6379
        run: pnpm --filter @the-dmz/api db:migrate
      - name: Smoke test database connection (placeholder)
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://dmz:dmz_dev@localhost:5432/dmz_dev
          REDIS_URL: redis://localhost:6379
        run: pnpm --filter @the-dmz/api db:smoke
