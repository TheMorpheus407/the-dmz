name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Enable corepack
        run: corepack enable
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Lint
        run: pnpm lint
      - name: Typecheck
        run: pnpm typecheck
      - name: Format check
        run: pnpm format:check

  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Enable corepack
        run: corepack enable
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package for tests
        run: pnpm --filter @the-dmz/shared build
      - name: Run unit tests with coverage
        env:
          CI: true
        run: |
          pnpm --filter @the-dmz/shared test -- \
            --coverage \
            --coverage.provider=v8 \
            --coverage.reporter=lcov \
            --coverage.reporter=text \
            --coverage.thresholds.lines=1 \
            --coverage.thresholds.functions=1 \
            --coverage.thresholds.branches=1 \
            --coverage.thresholds.statements=1
          pnpm --filter @the-dmz/api test -- \
            --coverage \
            --coverage.provider=v8 \
            --coverage.reporter=lcov \
            --coverage.reporter=text \
            --coverage.thresholds.lines=1 \
            --coverage.thresholds.functions=1 \
            --coverage.thresholds.branches=1 \
            --coverage.thresholds.statements=1
          pnpm --filter @the-dmz/web test -- \
            --coverage \
            --coverage.provider=v8 \
            --coverage.reporter=lcov \
            --coverage.reporter=text \
            --coverage.thresholds.lines=1 \
            --coverage.thresholds.functions=1 \
            --coverage.thresholds.branches=1 \
            --coverage.thresholds.statements=1
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.node }}
          path: |
            **/coverage/**
          if-no-files-found: warn

  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Enable corepack
        run: corepack enable
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build shared package
        run: pnpm --filter @the-dmz/shared build
      - name: Build web app
        run: pnpm --filter @the-dmz/web build
      - name: Build api app
        run: pnpm --filter @the-dmz/api build
      - name: Verify build artifacts
        run: |
          test -d packages/shared/dist
          test -d apps/web/build
          test -d apps/api/dist

  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [22.x]
    services:
      postgres:
        image: postgres:16-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: dmz
          POSTGRES_PASSWORD: dmz_dev
          POSTGRES_DB: dmz_dev
        options: >-
          --health-cmd "pg_isready -U dmz -d dmz_dev"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 5s
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - name: Enable corepack
        run: corepack enable
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run migrations (placeholder)
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://dmz:dmz_dev@localhost:5432/dmz_dev
          REDIS_URL: redis://localhost:6379
        run: pnpm --filter @the-dmz/api db:migrate
      - name: Smoke test database connection (placeholder)
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://dmz:dmz_dev@localhost:5432/dmz_dev
          REDIS_URL: redis://localhost:6379
        run: pnpm --filter @the-dmz/api db:smoke
